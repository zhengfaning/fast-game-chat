# Game Chat Stress Testing Tool

高性能 WebSocket 压力测试工具，专为游戏聊天系统设计。

## 特性

- ✨ **高性能**: 使用 Go 协程实现，充分利用多核 CPU
- 🚀 **快速**: 比 Python 版本快 10-100 倍
- 📊 **详细统计**: 实时统计成功率、延迟、吞吐量等指标
- 🎯 **灵活配置**: 支持自定义并发数、请求数、起始用户ID等
- 🔍 **调试模式**: 支持详细日志输出，方便问题排查

## 编译

```bash
cd scripts/stress_go
go build -o stress_test main.go
```

## 使用方法

### 基本用法

```bash
# 查看帮助
./stress_test -h

# 100 个用户，每个用户发送 10 条消息
./stress_test -c 100 -n 10

# 1000 个用户，每个用户发送 5 条消息
./stress_test -c 1000 -n 5

# 自定义 Gateway URL 和起始用户ID
./stress_test -c 500 -n 10 -u ws://192.168.1.100:8080/ws -s 3000

# 开启调试模式
./stress_test -c 10 -n 1 -d
```

### 参数说明

- `-c`: 并发用户数 (默认: 1)
- `-n`: 每个用户的请求数 (默认: 1)
- `-u`: Gateway WebSocket URL (默认: ws://localhost:8080/ws)
- `-s`: 起始用户ID (默认: 2000)
- `-d`: 调试模式 (默认: false)

### 示例

#### 快速测试 (10用户)
```bash
./stress_test -c 10 -n 3
```

#### 中等压力 (500用户)
```bash
./stress_test -c 500 -n 5
```

#### 高压力 (1000用户)
```bash
./stress_test -c 1000 -n 10
```

#### 极限压力 (5000用户)
```bash
./stress_test -c 5000 -n 5
```

## 性能对比

| 工具 | 1000用户 | 5000用户 | CPU利用率 |
|------|---------|---------|----------|
| Python (multiprocessing) | ~127秒 | ~10分钟+ | 中等 |
| Go (goroutine) | ~10秒 | ~50秒 | 高效 |

## 输出示例

```
========================================
  Game Chat Stress Testing Tool
  高性能 WebSocket 压力测试工具
========================================
Go Version: go1.21.0
CPU Cores: 16
OS/Arch: linux/amd64
========================================

🚀 开始压测...
   并发用户: 1000
   每用户请求数: 5
   总请求数: 5000
   Gateway: ws://localhost:8080/ws
   用户ID范围: 2000 - 2999

...完成...

========================================
         压力测试结果汇总
========================================
并发用户数:      1000
每用户请求数:    5
总请求数:        5000
----------------------------------------
成功:            5000 (100.00%)
失败:            0 (0.00%)
----------------------------------------
消息发送:        5000
消息接收:        5000
----------------------------------------
测试时长:        10.23 秒
吞吐量:          488.52 请求/秒
用户吞吐:        97.70 用户/秒
----------------------------------------
平均延迟:        102ms
最小延迟:        45ms
最大延迟:        350ms
----------------------------------------
========================================
✅ 测试通过！所有请求成功完成
```

## 架构设计

```
stress_go/
├── main.go              # 主入口，命令行参数处理
├── model/               # 数据模型
│   ├── request.go       # 请求配置
│   └── result.go        # 结果统计
├── client/              # 客户端实现
│   └── game_chat_client.go  # 游戏聊天客户端
├── server/              # 服务端逻辑
│   └── dispose.go       # 压测调度器
└── statistics/          # 统计模块
    └── statistics.go    # 统计收集器
```

## 技术特点

1. **协程池**: 每个用户一个 goroutine，轻量级并发
2. **无锁统计**: 使用 atomic 操作，避免锁竞争
3. **连接复用**: 每个用户复用 WebSocket 连接
4. **优雅错误处理**: panic recovery，单个用户失败不影响整体
5. **实时进度**: 异步统计收集，不阻塞测试进程

## 注意事项

1. 确保系统文件描述符限制足够大 (`ulimit -n`)
2. 高并发时注意网络带宽和服务器性能
3. 调试模式会产生大量日志，仅用于小规模测试
4. 建议先从小规模测试开始，逐步增加并发数

## 故障排查

### 连接失败
- 检查 Gateway 是否正常运行
- 检查网络连接和防火墙设置
- 确认 URL 格式正确

### 性能不佳
- 检查 CPU 和内存使用情况
- 调整并发数和请求数
- 检查网络延迟

### 消息丢失
- 检查服务端日志
- 增加超时时间
- 减少并发数进行测试

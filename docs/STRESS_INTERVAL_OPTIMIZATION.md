# å‹æµ‹å·¥å…·è¿æ¥é—´éš”ä¼˜åŒ–

## æ–°å¢åŠŸèƒ½

å‹æµ‹å·¥å…·ç°åœ¨æ”¯æŒ**å¯é…ç½®çš„è¿æ¥é—´éš”**ï¼Œå¯ä»¥æ¨¡æ‹Ÿä¸åŒå¼ºåº¦çš„å†²å‡»ã€‚

### ä½¿ç”¨æ–¹å¼

```bash
./scripts/stress_go/stress_test -c <å¹¶å‘æ•°> -n <æ¶ˆæ¯æ•°> -i <é—´éš”æ¯«ç§’>
```

**å‚æ•°è¯´æ˜**:
- `-i`: è¿æ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 2ms
  - `0`: æ— é—´éš”å†²å‡»ï¼ˆæœ€çŒ›çƒˆï¼Œç¬æ—¶å»ºç«‹æ‰€æœ‰è¿æ¥ï¼‰
  - `1`: 1ms é—´éš”ï¼ˆæé«˜å‹åŠ›ï¼‰
  - `2`: 2ms é—´éš”ï¼ˆé»˜è®¤ï¼Œå¹³è¡¡æ¨¡å¼ï¼‰
  - `5`: 5ms é—´éš”ï¼ˆæ¸©å’Œæ¨¡å¼ï¼‰

---

## å‹æµ‹ç»“æœå¯¹æ¯”

### æµ‹è¯•ç¯å¢ƒ
- **å¹¶å‘**: 100000 ç”¨æˆ·
- **æ¶ˆæ¯**: æ¯ç”¨æˆ· 2 æ¡
- **æ¶æ„**: Lock-Free (concurrent-map)

### ä¸åŒé—´éš”çš„è¡¨ç°

| é—´éš” | æˆåŠŸç‡ | å¹³å‡å»¶è¿Ÿ | æœ€å¤§å»¶è¿Ÿ | ååé‡ | è¯„ä»· |
|------|--------|----------|----------|--------|------|
| **0ms** | 3.35% | 4.17s | 19.96s | 29 req/s | âŒ ç³»ç»Ÿè¿‡è½½ |
| **2ms** | 100% | 2.09ms | 25ms | 836 req/s | âœ… å¹³è¡¡æœ€ä¼˜ |

---

## å…³é”®å‘ç°

### 1. ç¬æ—¶å†²å‡»çš„ç“¶é¢ˆ

**0ms é—´éš”**ï¼ˆ100000 ä¸ªè¿æ¥åœ¨ ~10ms å†…å…¨éƒ¨å‘èµ·ï¼‰ï¼š
- âŒ **æˆåŠŸç‡æš´è·Œè‡³ 3.35%**
- âŒ å¹³å‡å»¶è¿Ÿé£™å‡è‡³ **4.17 ç§’**
- âŒ å¤§é‡è¶…æ—¶é”™è¯¯

**ç“¶é¢ˆåˆ†æ**:
```
ç¬æ—¶è¿æ¥é£æš´
   â†“
æ“ä½œç³»ç»Ÿ TCP è¿æ¥é˜Ÿåˆ—æ»¡
   â†“  
accept() é˜»å¡
   â†“
å®¢æˆ·ç«¯ bind è¶…æ—¶
```

### 2. ç³»ç»Ÿç“¶é¢ˆä¸åœ¨åº”ç”¨å±‚

å³ä½¿ä½¿ç”¨äº† Lock-Free æ¶æ„ï¼Œåœ¨ 0ms é—´éš”ä¸‹ä»ç„¶å¤±è´¥ï¼Œè¯´æ˜ç“¶é¢ˆåœ¨ï¼š
- **TCP å±‚**: `net.core.somaxconn` (é»˜è®¤ 128)
- **æ–‡ä»¶æè¿°ç¬¦**: `ulimit -n` é™åˆ¶
- **ç«¯å£è€—å°½**: TIME_WAIT çŠ¶æ€çš„è¿æ¥

### 3. 2ms é—´éš”çš„åˆç†æ€§

**ä¸ºä»€ä¹ˆ 2ms æ˜¯æœ€ä¼˜é€‰æ‹©**:
- âœ… 100000 è¿æ¥åœ¨ **20 ç§’**å†…å®Œæˆå»ºç«‹ï¼ˆå¯æ¥å—ï¼‰
- âœ… é¿å… TCP é˜Ÿåˆ—æº¢å‡º
- âœ… ç³»ç»Ÿæœ‰æ—¶é—´å¤„ç†æ¯ä¸ªè¿æ¥
- âœ… 100% æˆåŠŸç‡

---

##ä¼˜åŒ–å»ºè®®

### å¦‚éœ€æ‰¿è½½ç¬æ—¶å†²å‡»ï¼Œéœ€è°ƒä¼˜æ“ä½œç³»ç»Ÿ

#### 1. å¢å¤§ TCP è¿æ¥é˜Ÿåˆ—
```bash
# ä¸´æ—¶è°ƒæ•´
sudo sysctl -w net.core.somaxconn=4096
sudo sysctl -w net.ipv4.tcp_max_syn_backlog=8192

# æ°¸ä¹…é…ç½®
echo "net.core.somaxconn=4096" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog=8192" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

#### 2. å¢å¤§æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
```bash
# ä¸´æ—¶
ulimit -n 1000000

# æ°¸ä¹… (/etc/security/limits.conf)
* soft nofile 1000000
* hard nofile 1000000
```

#### 3. ä¼˜åŒ– TIME_WAIT å›æ”¶
```bash
sudo sysctl -w net.ipv4.tcp_tw_reuse=1
sudo sysctl -w net.ipv4.tcp_fin_timeout=30
```

#### 4. å¢å¤§æœ¬åœ°ç«¯å£èŒƒå›´
```bash
sudo sysctl -w net.ipv4.ip_local_port_range="100000 65535"
```

---

## ä½¿ç”¨å»ºè®®

### åœºæ™¯ 1: æ—¥å¸¸å‹æµ‹
```bash
# ä½¿ç”¨é»˜è®¤ 2ms é—´éš”
make test-stress USERS=100000 MSGS=2
```

### åœºæ™¯ 2: éªŒè¯ç¬æ—¶å†²å‡»èƒ½åŠ›
```bash
# 0ms é—´éš”ï¼ˆéœ€å…ˆä¼˜åŒ–æ“ä½œç³»ç»Ÿï¼‰
./scripts/stress_go/stress_test -c 100000 -n 2 -i 0
```

### åœºæ™¯ 3: æ¨¡æ‹ŸçœŸå®æµé‡
```bash
# 5ms é—´éš”ï¼ˆæ›´æ¥è¿‘çœŸå®ç”¨æˆ·è¡Œä¸ºï¼‰
./scripts/stress_go/stress_test -c 100000 -n 5 -i 5
```

### åœºæ™¯ 4: æé™æµ‹è¯•
```bash
# 30000 å¹¶å‘ + 2ms é—´éš”
./scripts/stress_go/stress_test -c 30000 -n 2 -i 2
```

---

## Makefile å¢å¼ºå»ºè®®

å¯ä»¥åœ¨ Makefile ä¸­æ·»åŠ å¿«æ·æ–¹å¼ï¼š

```makefile
# ç¬æ—¶å†²å‡»æµ‹è¯•ï¼ˆéœ€OSä¼˜åŒ–ï¼‰
test-burst:
	@./scripts/stress_go/stress_test -c $(or $(USERS),100000) -n 2 -i 0

# æ¸©å’Œå‹æµ‹
test-mild:
	@./scripts/stress_go/stress_test -c $(or $(USERS),100000) -n 2 -i 5

# æé™å‹æµ‹
test-extreme:
	@./scripts/stress_go/stress_test -c 50000 -n 2 -i 1
```

---

## ç»“è®º

âœ… **å¯é…ç½®è¿æ¥é—´éš”**åŠŸèƒ½å·²æˆåŠŸå®ç°  
âœ… **2ms é—´éš”**æ˜¯å½“å‰æœ€ä¼˜é…ç½®ï¼ˆ100% æˆåŠŸç‡ï¼‰  
âš ï¸ **0ms é—´éš”**éœ€è¦æ“ä½œç³»ç»Ÿçº§ä¼˜åŒ–æ‰èƒ½æ”¯æŒ  
ğŸš€ **åº”ç”¨å±‚æ€§èƒ½å·²è¾¾æé™**ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–éœ€è°ƒä¼˜OSå’Œç½‘ç»œæ ˆ

---

**æ›´æ–°æ—¶é—´**: 2025-12-19  
**ä½œè€…**: Performance Optimization Team
